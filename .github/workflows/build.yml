name: Build and publish Flatpak repository

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-23.08
      options: --privileged

    steps:
      - uses: actions/checkout@v3

      - name: Setup environment
        shell: bash
        run: |
          echo "Setting up environment..."
          # Set up a user as the docker image comes with none
          cat <<EOF > /etc/passwd
          root:x:0:0:root:/root:/bin/bash
          EOF
          
          cat <<EOF > /etc/group
          root:x:0:
          EOF
          
          # Configure Git for Flatpak operations
          git config --global --add safe.directory /__w/flatpak-pieces-test/flatpak-pieces-test
          
          # Add Flathub repository for dependencies
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          
          # Clone shared-modules if needed
          if [ ! -d "shared-modules" ]; then
            git clone https://github.com/flathub/shared-modules
          fi
          
          # Save passphrase to a file (will be deleted later)
          echo "${{ secrets.GPG_PASSPHRASE }}" > /tmp/passphrase.txt
          chmod 600 /tmp/passphrase.txt
          
          # Import the GPG key
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          
          # Configure GPG for non-interactive use
          mkdir -p ~/.gnupg
          cat > ~/.gnupg/gpg.conf << EOF
          batch
          no-tty
          pinentry-mode loopback
          EOF
          
          # Set trust level for the key
          echo -e "5\ny\n" | gpg --command-fd 0 --no-tty --batch --edit-key ${{ secrets.GPG_KEY_ID }} trust

      - name: Fix icon issues
        env:
          APP_ID: com.pieces.os
        shell: bash
        run: |
          cd apps/${APP_ID}
          
          # Fix icon naming
          if [ -f "pieces_server.png" ]; then
            cp pieces_server.png ${APP_ID}.png
          
            # Update desktop file
            if [ -f "pieces-os.desktop" ]; then
              sed -i "s/Icon=pieces_server/Icon=${APP_ID}/g" pieces-os.desktop
            fi
          fi
          
          cd -

      # Try to build without custom SIGN_WITH script
      - name: Build Pieces OS
        env:
          APP_ID: com.pieces.os
          GPG_TTY: /dev/null
        shell: bash
        run: |
          # Export PASSPHRASE env variable for GPG
          export GNUPGHOME=~/.gnupg
          export GPG_TTY=$(tty || echo /dev/null)
          export PASSPHRASE="${{ secrets.GPG_PASSPHRASE }}"
          
          # Configure GPG agent to use passphrase
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          gpgconf --reload gpg-agent
          
          # Try to sign with environment variable passphrase
          echo "Building the app..."
          echo "$PASSPHRASE" | flatpak-builder --verbose --user --install-deps-from=flathub --gpg-sign=${{ secrets.GPG_KEY_ID }} --gpg-homedir=$GNUPGHOME --disable-rofiles-fuse --disable-updates --force-clean --repo=repo apps/${APP_ID}/${APP_ID}.yaml

      - name: Update repository
        env:
          GPG_TTY: /dev/null
        shell: bash
        run: |
          # Export PASSPHRASE env variable for GPG
          export GNUPGHOME=~/.gnupg
          export GPG_TTY=$(tty || echo /dev/null)
          export PASSPHRASE="${{ secrets.GPG_PASSPHRASE }}"
          
          # Update repo with GPG signing
          echo "$PASSPHRASE" | flatpak build-update-repo --gpg-sign=${{ secrets.GPG_KEY_ID }} --gpg-homedir=$GNUPGHOME --generate-static-deltas --prune repo/

      - name: Clean up sensitive information
        if: always()
        shell: bash
        run: |
          # Remove the passphrase file
          rm -f /tmp/passphrase.txt

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          force_orphan: true